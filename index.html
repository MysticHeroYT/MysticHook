<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MysticHook</title>
  <!-- Load Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7sLw/dZt3Rz5sP/f6KkF58pG9pGgG8+2pP+jJk2U2lK4yUu3QzB6K8CgC8vJ7vTf8lE/pL0NqP6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Custom Favicon (inline SVG) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 0 C77.6 0 100 22.4 100 50 C100 77.6 77.6 100 50 100 C22.4 100 0 77.6 0 50 C0 22.4 22.4 0 50 0 Z' fill='%235865f2'/%3E%3Cpath d='M30 65 L45 80 L70 55 L55 40 Z' fill='%23fff'/%3E%3C/svg%3E">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a202c;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>

  <!-- Load React, ReactDOM, and Babel from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Load Firebase from CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Global Firebase instances
    try {
      window.app = initializeApp(firebaseConfig);
      window.auth = getAuth(window.app);
      window.db = getFirestore(window.app);
      window.signInWithCustomToken = signInWithCustomToken;
      window.signInAnonymously = signInAnonymously;
      window.onAuthStateChanged = onAuthStateChanged;
      window.doc = doc;
      window.setDoc = setDoc;
      window.getDoc = getDoc;
    } catch (e) {
      console.error("Firebase initialization failed:", e);
    }
  </script>

  <!-- The main React app script, now using Babel -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    // A simple tooltip component
    const Tooltip = ({ text, children }) => (
      <div className="relative group inline-block">
        {children}
        <span className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 px-3 py-1 bg-gray-600 text-white text-xs rounded-md whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          {text}
        </span>
      </div>
    );
    
    // Custom SVG icon as a data URL
    const mysticHookIconUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 0 C77.6 0 100 22.4 100 50 C100 77.6 77.6 100 50 100 C22.4 100 0 77.6 0 50 C0 22.4 22.4 0 50 0 Z' fill='%235865f2'/%3E%3Cpath d='M30 65 L45 80 L70 55 L55 40 Z' fill='%23fff'/%3E%3C/svg%3E";


    const App = () => {
      // Firebase-related state
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      // Core webhook state
      const [embeds, setEmbeds] = useState([]);
      const [currentEmbedIndex, setCurrentEmbedIndex] = useState(0);
      const [components, setComponents] = useState([]);
      const [messageContent, setMessageContent] = useState('');
      const [username, setUsername] = useState('MysticHook');
      const [avatarUrl, setAvatarUrl] = useState('');
      const [webhookUrl, setWebhookUrl] = useState('');
      const [tts, setTts] = useState(false);
      const [threadId, setThreadId] = useState('');
      const [messageId, setMessageId] = useState('');
      const [file, setFile] = useState(null);
      const [audioFile, setAudioFile] = useState(null);
      const [isRecording, setIsRecording] = useState(false);
      const [recorder, setRecorder] = useState(null);
      const [saveStatus, setSaveStatus] = useState('');

      // Voice message state
      const [audioBlob, setAudioBlob] = useState(null);

      // Firestore Initialization
      useEffect(() => {
        if (!window.auth || !window.db) {
          console.error("Firebase instances are not available.");
          setLoading(false);
          return;
        }

        const initAuth = async () => {
          try {
            if (window.initialAuthToken) {
              await window.signInWithCustomToken(window.auth, window.initialAuthToken);
            } else {
              await window.signInAnonymously(window.auth);
            }
          } catch (error) {
            console.error('Error during Firebase sign-in:', error);
            await window.signInAnonymously(window.auth);
          }
        };

        const unsubscribe = window.onAuthStateChanged(window.auth, (currentUser) => {
          setUser(currentUser);
          setLoading(false);
          // Load data after a user is authenticated
          if (currentUser) {
            loadApp(window.db, currentUser);
          }
        });
        
        initAuth();

        return () => unsubscribe();
      }, []);

      // Firestore Save/Load functions
      const saveApp = async () => {
        if (!window.db || !user) {
          setSaveStatus('Error: User not authenticated.');
          return;
        }
        const userId = user.uid;
        const userDocRef = window.doc(window.db, 'artifacts', window.appId, 'users', userId, 'webhooks', 'data');
        try {
          setSaveStatus('Saving...');
          const dataToSave = {
            embeds: embeds,
            messageContent: messageContent,
            username: username,
            avatarUrl: avatarUrl,
            webhookUrl: webhookUrl,
            tts: tts,
            threadId: threadId,
            components: components,
            messageId: messageId
          };
          await window.setDoc(userDocRef, dataToSave);
          setSaveStatus('Saved successfully!');
        } catch (e) {
          console.error("Error saving document: ", e);
          setSaveStatus('Save Failed!');
        }
      };

      const loadApp = async (dbInstance, currentUser) => {
        if (!dbInstance || !currentUser) {
          setSaveStatus('Error: User not authenticated.');
          return;
        }
        const userId = currentUser.uid;
        const userDocRef = window.doc(dbInstance, 'artifacts', window.appId, 'users', userId, 'webhooks', 'data');
        try {
          setSaveStatus('Loading...');
          const docSnap = await window.getDoc(userDocRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            setEmbeds(data.embeds || []);
            setMessageContent(data.messageContent || '');
            setUsername(data.username || '');
            setAvatarUrl(data.avatarUrl || '');
            setWebhookUrl(data.webhookUrl || '');
            setTts(data.tts || false);
            setThreadId(data.threadId || '');
            setComponents(data.components || []);
            setMessageId(data.messageId || '');
            setSaveStatus('Loaded successfully!');
          } else {
            // If no data, set initial embeds.
            const initialEmbeds = [
              {
                title: 'Welcome to MysticHook!',
                description: "Start customizing your Discord message here. Use the form on the left to add text, embeds, and buttons, and see a live preview on the right.",
                color: '#5865f2',
                url: 'https://discord.com/',
                fields: [{ name: "Live Preview", value: "This section updates automatically as you type.", inline: true }]
              }
            ];
            setEmbeds(initialEmbeds);
            setSaveStatus('No saved data found, showing initial template.');
          }
        } catch (e) {
          console.error("Error loading document: ", e);
          setSaveStatus('Load Failed!');
        }
      };

      // State management for embeds and fields
      const handleEmbedChange = (field, value) => {
        const newEmbeds = [...embeds];
        newEmbeds[currentEmbedIndex] = { ...newEmbeds[currentEmbedIndex], [field]: value };
        setEmbeds(newEmbeds);
      };

      const handleFieldChange = (fieldIndex, field, value) => {
        const newEmbeds = [...embeds];
        const newFields = [...(newEmbeds[currentEmbedIndex].fields || [])];
        newFields[fieldIndex] = { ...newFields[fieldIndex], [field]: value };
        newEmbeds[currentEmbedIndex].fields = newFields;
        setEmbeds(newEmbeds);
      };

      const addField = () => {
        const newEmbeds = [...embeds];
        const newFields = [...(newEmbeds[currentEmbedIndex].fields || [])];
        newFields.push({ name: '', value: '', inline: false });
        newEmbeds[currentEmbedIndex].fields = newFields;
        setEmbeds(newEmbeds);
      };

      const deleteField = (index) => {
        const newEmbeds = [...embeds];
        const newFields = newEmbeds[currentEmbedIndex].fields.filter((_, i) => i !== index);
        newEmbeds[currentEmbedIndex].fields = newFields;
        setEmbeds(newEmbeds);
      };

      const addEmbed = () => {
        const newEmbed = {
          title: '', description: '', color: '#7289da', url: '', timestamp: false,
          author: { name: '', icon_url: '' },
          footer: { text: '', icon_url: '' },
          image: { url: '' }, thumbnail: { url: '' },
          fields: []
        };
        setEmbeds([...embeds, newEmbed]);
        setCurrentEmbedIndex(embeds.length);
      };

      // Updated deleteEmbed function
      const deleteEmbed = (index) => {
        const newEmbeds = embeds.filter((_, i) => i !== index);
        setEmbeds(newEmbeds);
        // Adjust the current index if the deleted one was the last one
        if (currentEmbedIndex >= newEmbeds.length) {
          setCurrentEmbedIndex(Math.max(0, newEmbeds.length - 1));
        }
      };

      // State management for components
      const addComponentRow = () => {
        setComponents([...components, { type: 1, components: [] }]);
      };

      const addRowComponent = (rowIndex) => {
        const newComponents = [...components];
        newComponents[rowIndex].components.push({ type: 2, label: 'Button', style: 1, custom_id: `button_${Math.random().toString(36).substring(2, 9)}` });
        setComponents(newComponents);
      };

      const handleComponentChange = (rowIndex, componentIndex, field, value) => {
        const newComponents = [...components];
        newComponents[rowIndex].components[componentIndex][field] = value;
        setComponents(newComponents);
      };

      const deleteComponent = (rowIndex, componentIndex) => {
        const newComponents = [...components];
        newComponents[rowIndex].components.splice(componentIndex, 1);
        if (newComponents[rowIndex].components.length === 0) {
          newComponents.splice(rowIndex, 1);
        }
        setComponents(newComponents);
      };

      const deleteComponentRow = (rowIndex) => {
        const newComponents = components.filter((_, i) => i !== rowIndex);
        setComponents(newComponents);
      };

      // Clipboard functionality
      const copyJson = () => {
        const payload = {};
        if (messageContent.trim()) payload.content = messageContent;
        if (username.trim()) payload.username = username;
        if (avatarUrl.trim()) payload.avatar_url = avatarUrl;
        if (tts) payload.tts = true;
        if (threadId.trim()) payload.thread_id = threadId;

        const validEmbeds = embeds.map(embed => {
          const embedPayload = {
            title: embed.title || undefined,
            description: embed.description || undefined,
            color: embed.color ? parseInt(embed.color.slice(1), 16) : undefined,
            url: embed.url || undefined,
            timestamp: embed.timestamp ? new Date().toISOString() : undefined,
            author: (embed.author?.name || embed.author?.icon_url) ? { name: embed.author.name || undefined, icon_url: embed.author.icon_url || undefined } : undefined,
            image: embed.image?.url ? { url: embed.image.url } : undefined,
            thumbnail: embed.thumbnail?.url ? { url: embed.thumbnail.url } : undefined,
            footer: (embed.footer?.text || embed.footer?.icon_url) ? { text: embed.footer.text || undefined, icon_url: embed.footer.icon_url || undefined } : undefined,
            fields: embed.fields?.length > 0 ? embed.fields.filter(f => f.name && f.value) : undefined,
          };
          Object.keys(embedPayload).forEach(key => embedPayload[key] === undefined && delete embedPayload[key]);
          return Object.keys(embedPayload).length > 0 ? embedPayload : null;
        }).filter(e => e !== null);

        if (validEmbeds.length > 0) payload.embeds = validEmbeds;
        if (components.length > 0) payload.components = components;

        const jsonOutput = JSON.stringify(payload, null, 2);
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = jsonOutput;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);

        setSaveStatus('JSON copied to clipboard!');
        setTimeout(() => setSaveStatus(''), 2000);
      };

      // Voice message recording functions
      const startRecording = async () => {
        if (isRecording) return;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mediaRecorder = new MediaRecorder(stream);
          setRecorder(mediaRecorder);
          let audioChunks = [];
          mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            setAudioBlob(audioBlob);
            setAudioFile(new File([audioBlob], "voice_message.mp3", { type: "audio/mp3" }));
            stream.getTracks().forEach(track => track.stop());
          };
          mediaRecorder.start();
          setIsRecording(true);
        } catch (err) {
          console.error('Error starting recording:', err);
          setSaveStatus('Error: Could not access microphone.');
        }
      };

      const stopRecording = () => {
        if (recorder) {
          recorder.stop();
          setIsRecording(false);
        }
      };

      const deleteVoiceRecording = () => {
        setAudioBlob(null);
        setAudioFile(null);
      };
      
      const currentEmbed = embeds[currentEmbedIndex] || null;
      
      if (loading) {
          return (
            <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
              <div className="text-xl">Loading...</div>
            </div>
          );
        }

      return (
        <div className="p-4 sm:p-6 bg-gray-900 min-h-screen font-sans antialiased text-white">
          <div className="flex justify-between items-center mb-6 flex-wrap">
            <h1 className="text-2xl sm:text-3xl font-bold text-white mb-2 sm:mb-0">MysticHook</h1>
            {user && (
              <div className="flex items-center space-x-2 sm:space-x-4 mt-2 lg:mt-0">
                <span className="text-gray-400 text-sm">User ID: <span className="font-mono break-all">{user?.uid}</span></span>
              </div>
            )}
          </div>

          <div className="container mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            {/* Input Form Section */}
            <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-xl overflow-y-auto" style={{ maxHeight: '90vh' }}>
              
              <div className="space-y-6">
                <h2 className="text-lg sm:text-xl font-semibold text-white border-b border-gray-700 pb-2">General Message Settings</h2>
                
                <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                  <label htmlFor="webhook-url" className="text-sm font-medium text-gray-400 w-full sm:w-auto">Webhook URL</label>
                  <Tooltip text="The unique URL provided by Discord for your webhook.">
                    <i className="fas fa-question-circle text-gray-500"></i>
                  </Tooltip>
                  <input type="url" id="webhook-url" placeholder="https://discord.com/api/webhooks/..." className="flex-1 w-full rounded-md bg-gray-700 border-transparent text-white focus:border-indigo-500 focus:ring-indigo-500" value={webhookUrl} onChange={(e) => setWebhookUrl(e.target.value)} />
                </div>

                <div>
                  <label htmlFor="message-content" className="block text-sm font-medium text-gray-400">Normal Message Content</label>
                  <textarea id="message-content" rows="3" placeholder="Enter your normal message here..." className="mt-1 block w-full rounded-md bg-gray-700 border-transparent text-white focus:border-indigo-500 focus:ring-indigo-500" value={messageContent} onChange={(e) => setMessageContent(e.target.value)}></textarea>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="username" className="block text-sm font-medium text-gray-400">Custom Username</label>
                    <input type="text" id="username" placeholder="Override the webhook's username" className="mt-1 block w-full rounded-md bg-gray-700 border-transparent text-white" value={username} onChange={(e) => setUsername(e.target.value)} />
                  </div>
                  <div>
                    <label htmlFor="avatar-url" className="block text-sm font-medium text-gray-400">Custom Avatar URL</label>
                    <input type="url" id="avatar-url" placeholder="https://example.com/avatar.png" className="mt-1 block w-full rounded-md bg-gray-700 border-transparent text-white" value={avatarUrl} onChange={(e) => setAvatarUrl(e.target.value)} />
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label htmlFor="thread-id" className="block text-sm font-medium text-gray-400">Thread ID</label>
                    <input type="text" id="thread-id" placeholder="Optional Thread ID to post in" className="mt-1 block w-full rounded-md bg-gray-700 border-transparent text-white" value={threadId} onChange={(e) => setThreadId(e.target.value)} />
                  </div>
                  <div>
                    <label htmlFor="message-id" className="block text-sm font-medium text-gray-400">Message ID (for editing)</label>
                    <input type="text" id="message-id" placeholder="Optional Message ID to edit" className="mt-1 block w-full rounded-md bg-gray-700 border-transparent text-white" value={messageId} onChange={(e) => setMessageId(e.target.value)} />
                  </div>
                </div>

                <div className="flex items-center space-x-2">
                  <label htmlFor="tts-checkbox" className="text-sm font-medium text-gray-400">Text-to-Speech (TTS)</label>
                  <Tooltip text="If checked, the message content will be read aloud by Discord's TTS system.">
                    <i className="fas fa-question-circle text-gray-500"></i>
                  </Tooltip>
                  <input type="checkbox" id="tts-checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={tts} onChange={(e) => setTts(e.target.checked)} />
                </div>

                <div className="space-y-4">
                  <h2 className="text-lg sm:text-xl font-semibold text-white border-b border-gray-700 pb-2">Voice Message</h2>
                  <div id="voice-message-controls" className="flex flex-wrap items-center space-x-2 space-y-2 sm:space-y-0">
                    <button onClick={startRecording} className="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors" disabled={isRecording}>
                      <i className="fas fa-microphone"></i> {isRecording ? 'Recording...' : 'Record'}
                    </button>
                    <button onClick={stopRecording} className="py-2 px-4 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition-colors" disabled={!isRecording}>
                      <i className="fas fa-stop"></i> Stop
                    </button>
                    {audioBlob && (
                      <button onClick={deleteVoiceRecording} className="py-2 px-4 rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">
                        <i className="fas fa-trash"></i> Delete
                      </button>
                    )}
                  </div>
                  {audioBlob && (
                    <div className="mt-2 p-3 bg-gray-700 rounded-md">
                      <audio src={URL.createObjectURL(audioBlob)} controls className="w-full"></audio>
                    </div>
                  )}
                </div>
                
                <div className="space-y-4">
                  <h2 className="text-lg sm:text-xl font-semibold text-white border-b border-gray-700 pb-2">File Upload</h2>
                  <input type="file" id="file-input" className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-colors" onChange={(e) => setFile(e.target.files[0])} />
                  <div id="file-status" className="text-gray-400 text-sm mt-2">{file ? `File selected: ${file.name}` : 'No file selected.'}</div>
                </div>
                
                <div className="space-y-4">
                  <h2 className="text-lg sm:text-xl font-semibold text-white border-b border-gray-700 pb-2">Embeds</h2>
                  <div className="flex items-center space-x-2 mb-4 overflow-x-auto p-2">
                    {embeds.map((_, index) => (
                      <div key={index} className="flex-shrink-0 flex items-center space-x-1">
                        <button
                          onClick={() => setCurrentEmbedIndex(index)}
                          className={`py-1 px-3 rounded-md text-white text-sm whitespace-nowrap transition-colors ${index === currentEmbedIndex ? 'bg-indigo-600' : 'bg-gray-600 hover:bg-gray-700'}`}
                        >
                          Embed {index + 1}
                        </button>
                        <Tooltip text="Remove this embed">
                          <button
                            onClick={() => deleteEmbed(index)}
                            className="p-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors"
                          >
                            <i className="fas fa-trash-alt"></i>
                          </button>
                        </Tooltip>
                      </div>
                    ))}
                    <button onClick={addEmbed} className="flex-shrink-0 py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                      <i className="fas fa-plus"></i> Add Embed
                    </button>
                  </div>

                  {currentEmbed && (
                    <div className="space-y-4 p-4 bg-gray-700 rounded-lg">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="embed-title" className="block text-sm font-medium text-gray-400">Title</label>
                          <input type="text" id="embed-title" placeholder="Embed Title" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.title || ''} onChange={(e) => handleEmbedChange('title', e.target.value)} />
                        </div>
                        <div>
                          <label htmlFor="embed-url" className="block text-sm font-medium text-gray-400">URL (for title)</label>
                          <input type="url" id="embed-url" placeholder="URL for the embed title" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.url || ''} onChange={(e) => handleEmbedChange('url', e.target.value)} />
                        </div>
                      </div>
                      <div>
                        <label htmlFor="embed-description" className="block text-sm font-medium text-gray-400">Description</label>
                        <textarea id="embed-description" rows="3" placeholder="Embed Description" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.description || ''} onChange={(e) => handleEmbedChange('description', e.target.value)}></textarea>
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="embed-color" className="block text-sm font-medium text-gray-400">Color</label>
                          <input type="color" id="embed-color" value={currentEmbed.color || '#5865f2'} className="mt-1 rounded-md w-full h-10" onChange={(e) => handleEmbedChange('color', e.target.value)} />
                        </div>
                        <div className="flex items-center">
                          <label htmlFor="embed-timestamp" className="text-sm font-medium text-gray-400">Show Timestamp</label>
                          <input type="checkbox" id="embed-timestamp" className="rounded text-indigo-600 ml-2" checked={currentEmbed.timestamp || false} onChange={(e) => handleEmbedChange('timestamp', e.target.checked)} />
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="author-name" className="block text-sm font-medium text-gray-400">Author Name</label>
                          <input type="text" id="author-name" placeholder="Author Name" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.author?.name || ''} onChange={(e) => handleEmbedChange('author', { ...currentEmbed.author, name: e.target.value })} />
                        </div>
                        <div>
                          <label htmlFor="author-icon-url" className="block text-sm font-medium text-gray-400">Author Icon URL</label>
                          <input type="url" id="author-icon-url" placeholder="https://example.com/author.png" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.author?.icon_url || ''} onChange={(e) => handleEmbedChange('author', { ...currentEmbed.author, icon_url: e.target.value })} />
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="footer-text" className="block text-sm font-medium text-gray-400">Footer Text</label>
                          <input type="text" id="footer-text" placeholder="Footer Text" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.footer?.text || ''} onChange={(e) => handleEmbedChange('footer', { ...currentEmbed.footer, text: e.target.value })} />
                        </div>
                        <div>
                          <label htmlFor="footer-icon-url" className="block text-sm font-medium text-gray-400">Footer Icon URL</label>
                          <input type="url" id="footer-icon-url" placeholder="https://example.com/footer.png" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.footer?.icon_url || ''} onChange={(e) => handleEmbedChange('footer', { ...currentEmbed.footer, icon_url: e.target.value })} />
                        </div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor="embed-image-url" className="block text-sm font-medium text-gray-400">Image URL</label>
                          <input type="url" id="embed-image-url" placeholder="https://example.com/image.png" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.image?.url || ''} onChange={(e) => handleEmbedChange('image', { url: e.target.value })} />
                        </div>
                        <div>
                          <label htmlFor="embed-thumbnail-url" className="block text-sm font-medium text-gray-400">Thumbnail URL</label>
                          <input type="url" id="embed-thumbnail-url" placeholder="https://example.com/thumbnail.png" className="mt-1 block w-full rounded-md bg-gray-600 border-transparent text-white" value={currentEmbed.thumbnail?.url || ''} onChange={(e) => handleEmbedChange('thumbnail', { url: e.target.value })} />
                        </div>
                      </div>
                      <div className="space-y-4 mt-4">
                        <h3 className="text-base sm:text-lg font-semibold text-white">Fields</h3>
                        {currentEmbed.fields.map((field, fieldIndex) => (
                          <div key={fieldIndex} className="bg-gray-600 p-3 rounded-md space-y-2">
                            <div className="flex space-x-2 items-center">
                              <input type="text" value={field.name} placeholder="Field Name" className="flex-1 rounded-md bg-gray-500 border-transparent text-white" onChange={(e) => handleFieldChange(fieldIndex, 'name', e.target.value)} />
                              <Tooltip text="Delete this field">
                                <button onClick={() => deleteField(fieldIndex)} className="p-1 rounded-full text-white bg-red-500 hover:bg-red-600 transition-colors">
                                  <i className="fas fa-trash-alt text-xs"></i>
                                </button>
                              </Tooltip>
                            </div>
                            <textarea rows="2" value={field.value} placeholder="Field Value" className="block w-full rounded-md bg-gray-500 border-transparent text-white" onChange={(e) => handleFieldChange(fieldIndex, 'value', e.target.value)}></textarea>
                            <label className="flex items-center space-x-2 text-gray-400">
                              <input type="checkbox" checked={field.inline} className="rounded text-indigo-600" onChange={(e) => handleFieldChange(fieldIndex, 'inline', e.target.checked)} />
                              <span>Inline</span>
                            </label>
                          </div>
                        ))}
                        <button onClick={addField} className="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                          <i className="fas fa-plus"></i> Add Field
                        </button>
                      </div>
                    </div>
                  )}
                </div>

                <div className="space-y-4">
                  <h2 className="text-lg sm:text-xl font-semibold text-white border-b border-gray-700 pb-2">Buttons & Components</h2>
                  <button onClick={addComponentRow} className="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                    <i className="fas fa-plus"></i> Add an Action Row
                  </button>
                  {components.map((row, rowIndex) => (
                    <div key={rowIndex} className="p-4 bg-gray-700 rounded-lg space-y-4">
                      <div className="flex justify-between items-center border-b border-gray-600 pb-2">
                        <h3 className="text-base sm:text-lg font-semibold text-white">Action Row {rowIndex + 1}</h3>
                        <Tooltip text="Delete this entire row">
                          <button onClick={() => deleteComponentRow(rowIndex)} className="p-1 rounded-full text-white bg-red-600 hover:bg-red-700 transition-colors">
                            <i className="fas fa-trash-alt text-xs"></i>
                          </button>
                        </Tooltip>
                      </div>
                      {row.components.map((comp, compIndex) => {
                          const buttonStyleMap = {
                            1: 'bg-indigo-600 hover:bg-indigo-700',
                            2: 'bg-gray-600 hover:bg-gray-700',
                            3: 'bg-green-600 hover:bg-green-700',
                            4: 'bg-red-600 hover:bg-red-700',
                          };
                          const buttonStyle = buttonStyleMap[comp.style] || 'bg-gray-600 hover:bg-gray-700';
                          return (
                            <div key={compIndex} className="bg-gray-600 p-3 rounded-md space-y-2">
                              <div className="flex space-x-2 items-center">
                                <input type="text" value={comp.label} placeholder="Button Label" className="flex-1 rounded-md bg-gray-500 border-transparent text-white" onChange={(e) => handleComponentChange(rowIndex, compIndex, 'label', e.target.value)} />
                                <Tooltip text="Delete this button">
                                  <button onClick={() => deleteComponent(rowIndex, compIndex)} className="p-1 rounded-full text-white bg-red-500 hover:bg-red-600 transition-colors">
                                    <i className="fas fa-trash-alt text-xs"></i>
                                  </button>
                                </Tooltip>
                              </div>
                              <select value={comp.style} className="block w-full rounded-md bg-gray-500 border-transparent text-white" onChange={(e) => handleComponentChange(rowIndex, compIndex, 'style', parseInt(e.target.value))}>
                                <option value="1">Primary (Blue)</option>
                                <option value="2">Secondary (Gray)</option>
                                <option value="3">Success (Green)</option>
                                <option value="4">Danger (Red)</option>
                              </select>
                              <input type="text" value={comp.custom_id} placeholder="Custom ID" className="block w-full rounded-md bg-gray-500 border-transparent text-white" onChange={(e) => handleComponentChange(rowIndex, compIndex, 'custom_id', e.target.value)} />
                            </div>
                          );
                        })}
                      <button onClick={() => addRowComponent(rowIndex)} className="w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-colors">
                        <i className="fas fa-plus"></i> Add a Button to this Row
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Preview Section */}
            <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-xl relative overflow-y-auto" style={{ maxHeight: '90vh' }}>
              <h1 className="text-2xl sm:text-3xl font-bold text-white mb-6">Live Preview</h1>
              <div className="bg-[#36393f] p-4 rounded-lg shadow-inner">
                <div className="flex items-start space-x-4">
                  <img src={mysticHookIconUrl} alt="User Avatar" className="w-10 h-10 rounded-full flex-shrink-0" />
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-2 mb-1">
                      <span className="font-semibold text-lg text-white">{username || 'MysticHook'}</span>
                      <span className="text-sm text-gray-400">{new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    {messageContent && (
                      <p className="text-gray-200 text-sm mb-4 break-words">{messageContent}</p>
                    )}
                    {embeds.map((embed, index) => (
                      <div key={index} className="bg-gray-700 p-4 rounded-lg border-l-4 mb-4" style={{ borderLeftColor: embed.color || '#5865f2' }}>
                        {embed.author?.name && (
                          <div className="flex items-center mb-2 space-x-2">
                            <img src={embed.author.icon_url || 'https://placehold.co/32x32/1e1e1e/888888?text=A'} alt="Author" className="w-8 h-8 rounded-full flex-shrink-0" onError={(e) => e.target.style.display='none'} />
                            <span className="text-gray-300 font-semibold">{embed.author.name}</span>
                          </div>
                        )}
                        <div className="flex items-start flex-wrap-reverse md:flex-wrap">
                          {embed.thumbnail?.url && <img src={embed.thumbnail.url} alt="Thumbnail" className="w-20 h-20 rounded-md float-right ml-4 object-cover" onError={(e) => e.target.style.display='none'} />}
                          <div className="flex-1 min-w-0">
                            {embed.title && <h2 className="text-white font-bold text-lg break-words">{embed.title}</h2>}
                            {embed.description && <p className="text-gray-300 text-sm mt-1 break-words">{embed.description}</p>}
                            {embed.fields?.length > 0 && (
                              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-2 mt-4">
                                {embed.fields.map((field, fieldIndex) => (
                                  <div key={fieldIndex} className="p-2 border-l-2 border-gray-500">
                                    <h3 className="text-white font-semibold text-sm break-words">{field.name}</h3>
                                    <p className="text-gray-400 text-xs break-words">{field.value}</p>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                        {embed.image?.url && <img src={embed.image.url} alt="Image" className="mt-4 rounded-md w-full h-auto object-cover" onError={(e) => e.target.style.display='none'} />}
                        {(embed.footer?.text || embed.footer?.icon_url) && (
                          <div className="flex items-center space-x-2 mt-4 text-sm text-gray-400">
                            <img src={embed.footer.icon_url || 'https://placehold.co/20x20/1e1e1e/888888?text=F'} alt="Footer" className="w-5 h-5 rounded-full flex-shrink-0" onError={(e) => e.target.style.display='none'} />
                            <span>{embed.footer.text}</span>
                          </div>
                        )}
                        {embed.timestamp && <div className="text-xs text-gray-500 mt-2">{new Date().toLocaleDateString()} {new Date().toLocaleTimeString()}</div>}
                      </div>
                    ))}
                    {audioBlob && (
                      <div className="p-3 bg-gray-700 rounded-md">
                        <audio src={URL.createObjectURL(audioBlob)} controls className="w-full"></audio>
                      </div>
                    )}
                    {components.map((row, rowIndex) => (
                      <div key={rowIndex} className="flex flex-wrap space-x-2 space-y-2 mt-4">
                        {row.components.map((comp, compIndex) => {
                          const buttonStyleMap = {
                            1: 'bg-indigo-600 hover:bg-indigo-700',
                            2: 'bg-gray-600 hover:bg-gray-700',
                            3: 'bg-green-600 hover:bg-green-700',
                            4: 'bg-red-600 hover:bg-red-700',
                          };
                          const buttonStyle = buttonStyleMap[comp.style] || 'bg-gray-600 hover:bg-gray-700';
                          return (
                            <button key={compIndex} className={`py-2 px-4 rounded-md text-white transition-colors ${buttonStyle}`}>
                              {comp.label}
                            </button>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="mt-6 flex flex-col items-center">
                <div className="flex flex-wrap justify-center space-x-4 mb-2">
                  <button onClick={saveApp} className="py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors mb-2 sm:mb-0">Save</button>
                  <button onClick={loadApp} className="py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors mb-2 sm:mb-0">Load</button>
                  <button onClick={copyJson} className="py-2 px-4 rounded-md text-white bg-gray-600 hover:bg-gray-700 transition-colors">Copy JSON</button>
                </div>
                {saveStatus && <p className="text-sm text-gray-400 text-center">{saveStatus}</p>}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Render the App component
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
